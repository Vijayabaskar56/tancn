{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "multi-select",
  "type": "registry:ui",
  "title": "Multi Select",
  "description": "A multi-select component built with Kobalte.",
  "dependencies": [
    "@kobalte/core"
  ],
  "files": [
    {
      "path": "registry/solid/multi-select.tsx",
      "content": "import { Popover as PopoverPrimitive } from \"@kobalte/core/popover\";\nimport { Check, ChevronUp, X } from \"lucide-solid\";\nimport type { ComponentProps, JSX, ValidComponent } from \"solid-js\";\nimport {\n\tcreateContext,\n\tcreateEffect,\n\tcreateMemo,\n\tcreateSignal,\n\tFor,\n\tShow,\n\tsplitProps,\n\tuseContext,\n} from \"solid-js\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n\tCommand,\n\tCommandEmpty,\n\tCommandGroup,\n\tCommandInput,\n\tCommandItem,\n\ttype CommandItemProps,\n\tCommandList,\n\tCommandSeparator,\n} from \"@/components/ui/command\";\nimport {\n\tPopover,\n\tPopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n\tTooltip,\n\tTooltipContent,\n\tTooltipProvider,\n\tTooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { cx } from \"@/utils/utils\";\n\nexport interface MultiSelectOptionItem {\n\tvalue: string;\n\tlabel?: JSX.Element;\n}\n\ninterface MultiSelectContextValue {\n\tvalue: () => string[];\n\topen: () => boolean;\n\tonSelect(value: string, item: MultiSelectOptionItem): void;\n\tonDeselect(value: string, item: MultiSelectOptionItem): void;\n\tonSearch?: (keyword: string | undefined) => void;\n\tfilter?: boolean | ((keyword: string, current: string) => boolean);\n\tdisabled?: boolean;\n\tmaxCount?: number;\n\titemCache: Map<string, MultiSelectOptionItem>;\n}\n\nconst MultiSelectContext = createContext<MultiSelectContextValue>();\n\nconst useMultiSelect = () => {\n\tconst context = useContext(MultiSelectContext);\n\tif (!context) {\n\t\tthrow new Error(\"useMultiSelect must be used within MultiSelect\");\n\t}\n\treturn context;\n};\n\ntype MultiSelectProps = ComponentProps<typeof Popover> & {\n\tvalue?: string[];\n\tonValueChange?: (value: string[], items: MultiSelectOptionItem[]) => void;\n\tonSelect?: (value: string, item: MultiSelectOptionItem) => void;\n\tonDeselect?: (value: string, item: MultiSelectOptionItem) => void;\n\tdefaultValue?: string[];\n\tonSearch?: (keyword: string | undefined) => void;\n\tfilter?: boolean | ((keyword: string, current: string) => boolean);\n\tdisabled?: boolean;\n\tmaxCount?: number;\n\tchildren?: JSX.Element;\n};\n\nexport const MultiSelect = (props: MultiSelectProps) => {\n\tconst [local, rest] = splitProps(props, [\n\t\t\"value\",\n\t\t\"onValueChange\",\n\t\t\"onDeselect\",\n\t\t\"onSelect\",\n\t\t\"defaultValue\",\n\t\t\"open\",\n\t\t\"onOpenChange\",\n\t\t\"defaultOpen\",\n\t\t\"onSearch\",\n\t\t\"filter\",\n\t\t\"disabled\",\n\t\t\"maxCount\",\n\t\t\"children\",\n\t]);\n\n\tconst itemCache = new Map<string, MultiSelectOptionItem>();\n\n\tconst [internalValue, setInternalValue] = createSignal<string[]>(\n\t\tlocal.defaultValue || [],\n\t);\n\tconst [internalOpen, setInternalOpen] = createSignal(\n\t\tlocal.defaultOpen || false,\n\t);\n\n\tconst value = createMemo(() => local.value ?? internalValue());\n\tconst open = createMemo(() => local.open ?? internalOpen());\n\n\tconst handleValueChange = (newValue: string[]) => {\n\t\tsetInternalValue(newValue);\n\t\tif (local.onValueChange) {\n\t\t\tconst items = newValue\n\t\t\t\t.map((v) => itemCache.get(v))\n\t\t\t\t.filter((item): item is MultiSelectOptionItem => item !== undefined);\n\t\t\tlocal.onValueChange(newValue, items);\n\t\t}\n\t};\n\n\tconst handleOpenChange = (isOpen: boolean) => {\n\t\tsetInternalOpen(isOpen);\n\t\tlocal.onOpenChange?.(isOpen);\n\t};\n\n\tconst handleSelect = (valueToSelect: string, item: MultiSelectOptionItem) => {\n\t\tconst current = value();\n\t\tif (current.includes(valueToSelect)) {\n\t\t\treturn;\n\t\t}\n\t\tlocal.onSelect?.(valueToSelect, item);\n\t\thandleValueChange([...current, valueToSelect]);\n\t};\n\n\tconst handleDeselect = (\n\t\tvalueToDeselect: string,\n\t\titem: MultiSelectOptionItem,\n\t) => {\n\t\tconst current = value();\n\t\tif (!current.includes(valueToDeselect)) {\n\t\t\treturn;\n\t\t}\n\t\tlocal.onDeselect?.(valueToDeselect, item);\n\t\thandleValueChange(current.filter((v) => v !== valueToDeselect));\n\t};\n\n\tconst contextValue: MultiSelectContextValue = {\n\t\tvalue,\n\t\topen,\n\t\tonSearch: local.onSearch,\n\t\tfilter: local.filter,\n\t\tdisabled: local.disabled,\n\t\tmaxCount: local.maxCount,\n\t\tonSelect: handleSelect,\n\t\tonDeselect: handleDeselect,\n\t\titemCache,\n\t};\n\n\treturn (\n\t\t<MultiSelectContext.Provider value={contextValue}>\n\t\t\t<Popover\n\t\t\t\topen={open()}\n\t\t\t\tonOpenChange={handleOpenChange}\n\t\t\t\t{...rest}\n\t\t\t>\n\t\t\t\t{local.children}\n\t\t\t</Popover>\n\t\t</MultiSelectContext.Provider>\n\t);\n};\n\ntype MultiSelectTriggerProps<T extends ValidComponent = \"div\"> = ComponentProps<T>;\n\nconst preventClick = (e: MouseEvent | TouchEvent) => {\n\te.preventDefault();\n\te.stopPropagation();\n};\n\nexport const MultiSelectTrigger = <T extends ValidComponent = \"div\">(\n\tprops: MultiSelectTriggerProps<T>,\n) => {\n\tconst [, rest] = splitProps(props, [\n\t\t\"class\",\n\t\t\"children\",\n\t] as const);\n\tconst { disabled } = useMultiSelect();\n\n\treturn (\n\t\t<PopoverTrigger\n\t\t\tas={(triggerProps: Record<string, unknown>) => (\n\t\t\t\t<button\n\t\t\t\t\ttype=\"button\"\n\t\t\t\t\taria-disabled={disabled}\n\t\t\t\t\tdata-disabled={disabled}\n\t\t\t\t\tclass={cx(\n\t\t\t\t\t\t\"flex min-h-10 size-full items-center justify-between whitespace-nowrap rounded-sm border border-input border-dashed bg-transparent px-3 py-2 shadow-xs ring-offset-background focus:outline-hidden focus:ring-1 focus:ring-ring [&>span]:line-clamp-1 text-base\",\n\t\t\t\t\t\tdisabled ? \"cursor-not-allowed opacity-50\" : \"cursor-text\",\n\t\t\t\t\t\tprops.class,\n\t\t\t\t\t)}\n\t\t\t\t\tonClick={disabled ? preventClick : undefined}\n\t\t\t\t\tonTouchStart={disabled ? preventClick : undefined}\n\t\t\t\t\tonKeyDown={\n\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t? (e) => {\n\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: undefined\n\t\t\t\t\t}\n\t\t\t\t\ttabIndex={disabled ? -1 : 0}\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\t{...triggerProps}\n\t\t\t\t\t{...rest}\n\t\t\t\t>\n\t\t\t\t\t{props.children}\n\t\t\t\t\t<ChevronUp class=\"size-4 opacity-50\" />\n\t\t\t\t</button>\n\t\t\t)}\n\t\t/>\n\t);\n};\n\ntype MultiSelectValueProps<T extends ValidComponent = \"div\"> = ComponentProps<T> & {\n\tplaceholder?: string;\n\tmaxDisplay?: number;\n\tmaxItemLength?: number;\n};\n\nexport const MultiSelectValue = <T extends ValidComponent = \"div\">(\n\tprops: MultiSelectValueProps<T>,\n) => {\n\tconst [, rest] = splitProps(props as MultiSelectValueProps, [\n\t\t\"class\",\n\t\t\"placeholder\",\n\t\t\"maxDisplay\",\n\t\t\"maxItemLength\",\n\t\t\"children\",\n\t] as const);\n\tconst { value, itemCache, onDeselect } = useMultiSelect();\n\n\tconst renderRemain = createMemo(() => {\n\t\tconst val = value();\n\t\treturn props.maxDisplay && val.length > props.maxDisplay\n\t\t\t? val.length - props.maxDisplay\n\t\t\t: 0;\n\t});\n\n\tconst renderItems = createMemo(() => {\n\t\tconst val = value();\n\t\tconst remain = renderRemain();\n\t\treturn remain ? val.slice(0, props.maxDisplay) : val;\n\t});\n\n\treturn (\n\t\t<Show\n\t\t\twhen={value().length > 0}\n\t\t\tfallback={\n\t\t\t\t<span class=\"pointer-events-none text-muted-foreground\">\n\t\t\t\t\t{props.placeholder}\n\t\t\t\t</span>\n\t\t\t}\n\t\t>\n\t\t\t<TooltipProvider delayDuration={300}>\n\t\t\t\t<div\n\t\t\t\t\tclass={cx(\n\t\t\t\t\t\t\"flex flex-1 overflow-x-hidden flex-wrap items-center gap-1.5\",\n\t\t\t\t\t\tprops.class,\n\t\t\t\t\t)}\n\t\t\t\t\t{...rest}\n\t\t\t\t>\n\t\t\t\t\t<For each={renderItems()}>\n\t\t\t\t\t\t{(val) => {\n\t\t\t\t\t\t\tconst item = itemCache.get(val);\n\t\t\t\t\t\t\tconst content = item?.label || val;\n\t\t\t\t\t\t\tconst contentStr =\n\t\t\t\t\t\t\t\ttypeof content === \"string\" ? content : String(content);\n\t\t\t\t\t\t\tconst child =\n\t\t\t\t\t\t\t\tprops.maxItemLength &&\n\t\t\t\t\t\t\t\tcontentStr.length > props.maxItemLength\n\t\t\t\t\t\t\t\t\t? `${contentStr.slice(0, props.maxItemLength)}...`\n\t\t\t\t\t\t\t\t\t: content;\n\n\t\t\t\t\t\t\tconst badge = (\n\t\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t\t\t\tclass=\"pr-1.5 group/multi-select-badge cursor-pointer rounded-full py-0.5\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => {\n\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tif (item) {\n\t\t\t\t\t\t\t\t\t\t\tonDeselect(val, item);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span>{child}</span>\n\t\t\t\t\t\t\t\t\t<X class=\"size-3 ml-1.5 text-muted-foreground group-hover/multi-select-badge:text-foreground\" />\n\t\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<Show\n\t\t\t\t\t\t\t\t\twhen={contentStr !== String(child)}\n\t\t\t\t\t\t\t\t\tfallback={badge}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<Tooltip>\n\t\t\t\t\t\t\t\t\t\t<TooltipTrigger class=\"inline-flex\">{badge}</TooltipTrigger>\n\t\t\t\t\t\t\t\t\t\t<TooltipContent class=\"z-51\">\n\t\t\t\t\t\t\t\t\t\t\t{contentStr}\n\t\t\t\t\t\t\t\t\t\t</TooltipContent>\n\t\t\t\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t\t\t\t</Show>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}}\n\t\t\t\t\t</For>\n\t\t\t\t\t<Show when={renderRemain() > 0}>\n\t\t\t\t\t\t<span class=\"text-muted-foreground text-xs leading-4 py-.5\">\n\t\t\t\t\t\t\t+{renderRemain()}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</Show>\n\t\t\t\t</div>\n\t\t\t</TooltipProvider>\n\t\t</Show>\n\t);\n};\n\nexport const MultiSelectSearch = <T extends ValidComponent = \"input\">(\n\tprops: ComponentProps<T>,\n) => {\n\tconst [, rest] = splitProps(props, [\n\t\t\"class\",\n\t\t\"onInput\",\n\t] as const);\n\tconst { onSearch } = useMultiSelect();\n\n\treturn (\n\t\t<CommandInput\n\t\t\t{...rest}\n\t\t\tclass={props.class}\n\t\t\tonValueChange={onSearch}\n\t\t/>\n\t);\n};\n\nexport const MultiSelectList = <T extends ValidComponent = \"div\">(\n\tprops: ComponentProps<T>,\n) => {\n\tconst [, rest] = splitProps(props, [\"class\"] as const);\n\n\treturn (\n\t\t<CommandList\n\t\t\tclass={cx(\"py-1 px-0 max-h-[unset]\", props.class)}\n\t\t\t{...rest}\n\t\t/>\n\t);\n};\n\ntype MultiSelectContentProps<T extends ValidComponent = \"div\"> = ComponentProps<T>;\n\nexport const MultiSelectContent = <T extends ValidComponent = \"div\">(\n\tprops: MultiSelectContentProps<T>,\n) => {\n\tconst [local, rest] = splitProps(props as MultiSelectContentProps, [\n\t\t\"class\",\n\t\t\"children\",\n\t] as const);\n\tconst context = useMultiSelect();\n\n\treturn (\n\t\t<PopoverPrimitive.Portal>\n\t\t\t<PopoverPrimitive.Content\n\t\t\t\tdata-slot=\"popover-content\"\n\t\t\t\talign=\"start\"\n\t\t\t\tsideOffset={4}\n\t\t\t\tonOpenAutoFocus={(e: Event) => {\n\t\t\t\t\t// Prevent auto-focus on open\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}}\n\t\t\t\tonCloseAutoFocus={(e: Event) => {\n\t\t\t\t\t// Prevent auto-focus when closing\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}}\n\t\t\t\tonFocusOutside={(e: Event) => {\n\t\t\t\t\t// ALWAYS prevent focus outside from closing\n\t\t\t\t\t// This is the key - focus changing shouldn't close the popover\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}}\n\t\t\t\tclass={cx(\n\t\t\t\t\t\"z-50 w-full rounded-sm border border-dashed bg-popover p-0 text-popover-foreground shadow-md outline-hidden data-expanded:animate-in data-closed:animate-out data-closed:fade-out-0 data-expanded:fade-in-0 data-closed:zoom-out-95 data-expanded:zoom-in-95\",\n\t\t\t\t\tlocal.class,\n\t\t\t\t)}\n\t\t\t\t{...rest}\n\t\t\t>\n\t\t\t\t<Command\n\t\t\t\t\tclass={cx(\"px-1 max-h-96 w-full\")}\n\t\t\t\t\tshouldFilter={!context.onSearch}\n\t\t\t\t>\n\t\t\t\t\t{local.children}\n\t\t\t\t</Command>\n\t\t\t</PopoverPrimitive.Content>\n\t\t</PopoverPrimitive.Portal>\n\t);\n};\n\ntype MultiSelectItemProps<T extends ValidComponent = \"div\"> = ComponentProps<T> &\n\tPartial<MultiSelectOptionItem> & {\n\t\tonSelect?: (value: string, item: MultiSelectOptionItem) => void;\n\t\tonDeselect?: (value: string, item: MultiSelectOptionItem) => void;\n\t\tdisabled?: boolean;\n\t};\n\nexport const MultiSelectItem = <T extends ValidComponent = \"div\">(\n\tprops: MultiSelectItemProps<T>,\n) => {\n\tconst [local] = splitProps(props as MultiSelectItemProps, [\n\t\t\"class\",\n\t\t\"value\",\n\t\t\"onSelect\",\n\t\t\"onDeselect\",\n\t\t\"children\",\n\t\t\"label\",\n\t\t\"disabled\",\n\t] as const);\n\n\tconst {\n\t\tvalue: contextValue,\n\t\tmaxCount,\n\t\tonSelect: contextOnSelect,\n\t\tonDeselect: contextOnDeselect,\n\t\titemCache,\n\t} = useMultiSelect();\n\n\tconst item = createMemo(() => {\n\t\tif (!local.value) return undefined;\n\t\treturn {\n\t\t\tvalue: local.value,\n\t\t\tlabel: local.label || (typeof local.children === \"string\" ? local.children : undefined),\n\t\t};\n\t});\n\n\tconst selected = createMemo(() => {\n\t\tconst val = local.value;\n\t\treturn val ? contextValue().includes(val) : false;\n\t});\n\n\tcreateEffect(() => {\n\t\tconst val = local.value;\n\t\tconst itm = item();\n\t\tif (val && itm) {\n\t\t\titemCache.set(val, itm);\n\t\t}\n\t});\n\n\tconst disabled = createMemo(() => {\n\t\treturn (\n\t\t\tlocal.disabled ||\n\t\t\t(!selected() && !!maxCount && contextValue().length >= maxCount)\n\t\t);\n\t});\n\n\tconst handleClick: (e?: MouseEvent) => void = (e?: MouseEvent) => {\n\t\tif (disabled() || !local.value) return;\n\t\tconst itm = item();\n\t\tif (!itm) return;\n\n\t\t// Prevent event from bubbling up to close the popover\n\t\tif (e) {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t}\n\n\t\tif (selected()) {\n\t\t\tlocal.onDeselect?.(local.value, itm);\n\t\t\tcontextOnDeselect(local.value, itm);\n\t\t} else {\n\t\t\titemCache.set(local.value, itm);\n\t\t\tlocal.onSelect?.(local.value, itm);\n\t\t\tcontextOnSelect(local.value, itm);\n\t\t}\n\t};\n\n\treturn (\n\t\t<CommandItem\n\t\t\tvalue={local.value}\n\t\t\tclass={cx(\n\t\t\t\tdisabled() && \"text-muted-foreground cursor-not-allowed\",\n\t\t\t\tlocal.class,\n\t\t\t)}\n\t\t\tdisabled={disabled()}\n\t\t\tonSelect={handleClick as CommandItemProps[\"onSelect\"]}\n\t\t>\n\t\t\t<span class=\"mr-2 whitespace-nowrap overflow-hidden text-ellipsis\">\n\t\t\t\t{local.children || local.label || local.value}\n\t\t\t</span>\n\t\t\t<Show when={selected()}>\n\t\t\t\t<Check class=\"h-4 w-4 ml-auto shrink-0\" />\n\t\t\t</Show>\n\t\t</CommandItem>\n\t);\n};\n\nexport const MultiSelectGroup = <T extends ValidComponent = \"div\">(\n\tprops: ComponentProps<typeof CommandGroup<T>>,\n) => {\n\treturn <CommandGroup {...props} />;\n};\n\nexport const MultiSelectSeparator = <T extends ValidComponent = \"div\">(\n\tprops: ComponentProps<T>,\n) => {\n\treturn <CommandSeparator {...props} />;\n};\n\nexport const MultiSelectEmpty = <T extends ValidComponent = \"div\">(\n\tprops: ComponentProps<T> & { children?: JSX.Element },\n) => {\n\treturn (\n\t\t<CommandEmpty {...props}>\n\t\t\t{props.children || \"No Content\"}\n\t\t</CommandEmpty>\n\t);\n};\n\nexport interface MultiSelectOptionSeparator {\n\ttype: \"separator\";\n}\n\nexport interface MultiSelectOptionGroup {\n\theading?: JSX.Element;\n\tvalue?: string;\n\tchildren: MultiSelectOption[];\n}\n\nexport type MultiSelectOption =\n\t| Pick<\n\t\t\tMultiSelectItemProps<\"div\">,\n\t\t\t\"value\" | \"label\" | \"onSelect\" | \"onDeselect\"\n\t  > & {\n\t\t\tdisabled?: boolean;\n\t  }\n\t| MultiSelectOptionSeparator\n\t| MultiSelectOptionGroup;\n\nexport const renderMultiSelectOptions = (list: MultiSelectOption[]) => {\n\treturn list.map((option) => {\n\t\tif (\"type\" in option) {\n\t\t\tif (option.type === \"separator\") {\n\t\t\t\treturn <MultiSelectSeparator />;\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tif (\"children\" in option) {\n\t\t\treturn (\n\t\t\t\t<MultiSelectGroup heading={option.heading}>\n\t\t\t\t\t{renderMultiSelectOptions(option.children)}\n\t\t\t\t</MultiSelectGroup>\n\t\t\t);\n\t\t}\n\n\t\treturn (\n\t\t\t<MultiSelectItem {...option}>\n\t\t\t\t{option.label}\n\t\t\t</MultiSelectItem>\n\t\t);\n\t});\n};\n\n",
      "type": "registry:ui"
    }
  ]
}